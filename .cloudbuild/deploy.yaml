steps:
  - id: 'pull-rust-cache'
    name: 'gcr.io/cloud-builders/docker'
    entrypoint: 'bash'
    args: ['-c', 'docker pull asia-docker.pkg.dev/icfpc-primary/asia/cache/rust-builder || exit 0']
  - id: 'build-rust-cache'
    name: 'gcr.io/cloud-builders/docker'
    args: [
              'build',
              '-t', 'asia-docker.pkg.dev/icfpc-primary/asia/cache/rust-builder',
              '--cache-from', 'asia-docker.pkg.dev/icfpc-primary/asia/cache/rust-builder',
              '-f', 'docker/builder.Dockerfile',
              '--target', 'rust-builder',
              '--build-arg', 'BUILDKIT_INLINE_CACHE=1',
              '.'
          ]
  - id: 'push-rust-cache'
    name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'asia-docker.pkg.dev/icfpc-primary/asia/cache/rust-builder']
  - id: 'build-binaries'
    name: 'gcr.io/cloud-builders/docker'
    args: [
              'build',
              '-t', 'asia-docker.pkg.dev/icfpc-primary/asia/cache/builder',
              '--cache-from', 'asia-docker.pkg.dev/icfpc-primary/asia/cache/rust-builder',
              '-f', 'docker/builder.Dockerfile',
              '.'
    ]
    waitFor: ['build-rust-cache']
  - id: 'push-binaries'
    name: 'gcr.io/cloud-builders/docker'
    args: [
              'run', '--rm', 'asia-docker.pkg.dev/icfpc-primary/asia/cache/builder',
              'bash', '/work/scripts/deploy_binaries.sh', '$SHORT_SHA',
      ]

options:
  env:
    - 'DOCKER_BUILDKIT=1'
  logging: CLOUD_LOGGING_ONLY
  machineType: 'E2_HIGHCPU_32'
